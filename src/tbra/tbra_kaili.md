# 凯利公式的推导

[链接：凯利公式，从赌场到量化投资-石川 ](https://zhuanlan.zhihu.com/p/38279377)

实质：(最终与预期的一致的) `ln(X_n)`一定会非常接近它的期望值`E[ln(X_n)]`

凯利公式解决了这样一个情景下的问题：在一个期望为正的重复性赌局或重复性投资中，每一期应该下注的最优比例。
长期收益为正因此玩下去是有利的，在此game中，需要做的决策是决定每局下注的金额。
### 1. 假设我们的目标是最大化`X_n`的期望`E[X_n]`：

```latex
E[X_n] = X_0 + \sigma^{n}_{i=1} E[B_i * T_i]
       = X_0 + \sigma^{n}_{i=1} (p-q) * E[B_i]
```
因为`p-q>0`, 正期望。相当于最大化当期下注金额的期望`E[B_i]`, 这意味着，每一局我们都应该有多少下多少。但，由于`p < 1`, 随着赌局数n的增加，"输掉全部"这种结果一定会出现，因此以`E[X_n]`为目标的下注策略并不是最优的。
### 2. 再看另一种策略——固定比例投注
`B_i` = `f * X_{i-1}`， `0<f<1` 。 S胜次数，F失败次数，S+F=n。
n局后资金 `X_n` = `X_0 * (1+f)^S * (1-f)^F`
由于`0<f<1`，显然不会输光，但`X_n`的取值显然与f有关，应该如何决定最优的f呢？且扔硬币的随机性，S和F的取值也是不能确定的，那么这个最优又是从什么意义上来讲的呢？

对平均单局的对数收益率：
```latex
G_n(f) = \limit_{n->inf} 1/n * ln[X_n / X_0]   , e为底
```
凯丽选择最大化平均单局对数收益率的期望，记为g(f):
```latex
g(f) = E[G_n(f)]
     = \limit_{n->inf} E{1/n * ln[X_n / X_0]}
     = \limit_{n->inf} E{S/n * ln(1+f) + F/n * ln(1-f)}
     = p*ln(1+f) + q*ln(1-f)

g'(f) = p / (1+f) - q / (1-f)  , 且g''(f)在(0,1)区间上恒为负。

通分后
g'(f) = (p - pf - q - qf) / (1-f)^2 = 0 时取极值

=> 最优的 f^* = (p-q) / (p+q) = p-q
```

这就是凯利公式的由来。

有通用式为：
- b为当赢时，下注资金从1变为 `1+b`
- c为当输时，下注资金从1变为 `1-c`
此时，`g(f) = p * ln(1+bf) + q * ln(1-cf)`，得到 `f^* = p/c - q/b

### 3. 下面来尝试理解`f^*`的实质！

#### 3.1. 理论上
如果一直按照`f^*`比例下注的策略来玩，将最大化对数收益率的期望。(按此比例下注实际上就是在最大化`E[ln(X_n)]`，即n局后资金量的对数期望，下文有证明)。

按`f^*`比例下注有两点颠覆性的优势(在数学上都已证明)：
1. (量上)随着局数n的增大，按照凯利公式下注的资金`X_n(f^*)`将远远超过按照任何其他比例的下注资金`X_n(f_i)`；
2. (速上)对于任何给定的目标资金额C，以凯利公式下注的策略超过该目标所需的期望时间(即期望局数)最少。

#### 3.2. 然后通过有限模拟一下，直观感知：
对于有限次的投资，是否有更好的下注比例呢？
一百万次蒙特卡洛初看终值和期望，`f^*`以90%的概率战胜其他f所需最小局数的热图
如果以周围频率，50次只不过是短短一年，以月为频率也不过4年出头，因此50次以内的投资在现实活动中是很容易达到的次数，很大概率保证以凯利公式执行时最优的。
即使对于有限的(本例为20)局数，凯利公式仍然是非凡的。

#### 3.3. 那么看来，无限和有限都展现了非凡，来尝试理解其本质为何！
假设初始资金`X_0 = 1`, 则 `ln(X_n) 可以改写为 => ln(X_n / X_0)`，就成为了整个n局的对数总收益率。
对数收益率好处是可加性，因此有 
```latex
ln[X_n / X_0] = ln[X_1/X_0 * X_2/X_1 * ... * X_n/X_{n-1}]
              = ln[X_1/X_0] + ln[X_2/X_1] + ... + ln[X_n/X_{n-1}]
```
由于不同期之间是相互独立的，n期对数收益率相加相当于n个独立随机变量相加，由中心极限定理(独立同分布，期望、方差都有限)序列部分和近似服从正态分布 => 则推出`ln[X_n]`随n增大，近似服从正态分布。
因此，`1/n * ln[X_n]`就是每期对数收益率的均值，再由大数定律可知`1/n * ln[X_n]`一定收敛于它的期望即`E[1/n * ln(X_n)]`。(出现了！最终结果与预期值关联上了！)。

我们玩一个投资，最终是想让`X_n`越大越好，但我们不知道`X_n`最终会变成什么样，或者说收敛到什么值。但上面的分析指出了，只要n足够大，大数定律保证了`X_n`的对数即`ln[X_n]`一定会非常接近它的期望`E[ln(X_n)]`。那么我们自然就想到要找一个下注比例使得`E[ln(X_n)]`尽可能的大，而凯利公式的`f^*`恰恰就是使得`E[ln(X_n)]`最大的下注比例。这就闭环了。


